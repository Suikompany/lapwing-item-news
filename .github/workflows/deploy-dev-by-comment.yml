name: Deploy `dev` By Comment

on:
  issue_comment:
    types:
      - created

permissions:
  id-token: write
  contents: read
  actions: read
  pull-requests: write

env:
  tf-dir: terraform/environment/dev

jobs:
  apply:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, '/deploy ')
    environment: dev
    timeout-minutes: 25
    steps:
      - name: validate and extract artifact id
        id: command-args
        uses: actions/github-script@v8
        timeout-minutes: 1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = context.payload.comment.body.trim();
            const match = comment.match(/^\/deploy\s+(\d+)\s+([a-zA-Z0-9_-]+)$/);
            if (!match) {
              throw new Error("Invalid comment format. Expected '/deploy <run-id> <artifact-id>'.");
            }
            core.setOutput("run-id", match[1]);
            core.setOutput("artifact-id", match[2]);
      - id: get-branch
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const pull_request = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            })
            return pull_request.data.head.ref
      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.get-branch.outputs.result }}
      - id: artifact
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.command-args.outputs.run-id }}
          artifact-ids: ${{ steps.command-args.outputs.artifact-id }}
          path: ${{ env.tf-dir }}
          merge-multiple: true # artifact„ÅÆÂÜÖÂÆπÁâ©„ÇípathÁõ¥‰∏ã„Å´ÈÖçÁΩÆ„Åï„Åõ„Çã
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.DEPLOY_ROLE_ARN }}
          aws-region: 'ap-northeast-1'
      - uses: hashicorp/setup-terraform@v3
      - id: tf-init
        run: terraform -chdir=${{ env.tf-dir }} init
      - id: tf-apply
        run: terraform -chdir=${{ env.tf-dir }} apply -auto-approve -no-color ${{ steps.artifact.outputs.download-path}}/tfplan
        timeout-minutes: 20
        env:
          TF_VAR_twitter_api_key: ${{ secrets.TWITTER_API_KEY }}
          TF_VAR_twitter_api_secret: ${{ secrets.TWITTER_API_SECRET }}
          TF_VAR_twitter_access_token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TF_VAR_twitter_access_token_secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
      - uses: actions/github-script@v8
        if: success() || failure()
        env:
          APPLY: "${{ steps.tf-apply.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Apply üì¶ \`${{ steps.tf-apply.outcome }}\`

            <details><summary>Show Apply</summary>

            \`\`\`terraform
            ${process.env.APPLY}
            \`\`\`

            </details>`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            })
