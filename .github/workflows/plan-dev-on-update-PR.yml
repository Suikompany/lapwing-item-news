name: Terraform plan on update PR

on:
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
    paths:
      - .github/workflows/plan-dev-on-update-PR.yml
      - .github/workflows/terraform-plan.yml
      - '**.ts'
      - terraform/environment/dev/**
      - terraform/module/**
      - esbuild.mjs
      - package.json
      - package-lock.json
      - tsconfig.json

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  tf-base: terraform/environment

jobs:
  plan:
    permissions:
      id-token: write
      contents: read
    uses: ./.github/workflows/terraform-plan.yml
    with:
      environment: dev
    secrets: inherit

  output:
    runs-on: ubuntu-latest
    needs: plan
    timeout-minutes: 5
    steps:
      - uses: actions/github-script@v8
        if: github.event_name == 'pull_request' && (success() || failure())
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Initialization ‚öôÔ∏è: \`${{ needs.plan.outputs.init-outcome }}\`
            #### Terraform Validation ü§ñ: \`${{ needs.plan.outputs.validate-outcome }}\`

            <details><summary>Validation Output</summary>

            \`\`\`
            ${{ needs.plan.outputs.validate-stdout }}
            \`\`\`

            </details>

            #### Terraform Plan üìñ: \`${{ needs.plan.outputs.plan-outcome }}\`

            <details><summary>Plan Output</summary>

            \`\`\`terraform
            ${{ needs.plan.outputs.plan-stdout }}
            \`\`\`

            </details>

            If you want to deploy this, please comment the following text.
            \`\`\`
            /deploy ${{ github.run_id }}
            \`\`\``;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            })
